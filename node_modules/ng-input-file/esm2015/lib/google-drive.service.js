/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { Injectable, isDevMode } from '@angular/core';
import { HttpClient, HttpHeaders } from '@angular/common/http';
import { Subject } from 'rxjs';
import { take } from 'rxjs/operators';
/**
 * @record
 */
export function GoogleApiConfig() { }
if (false) {
    /** @type {?} */
    GoogleApiConfig.prototype.developerKey;
    /** @type {?} */
    GoogleApiConfig.prototype.appId;
    /** @type {?} */
    GoogleApiConfig.prototype.clientId;
}
/** @type {?} */
const GOOGLE_API_URL = 'https://apis.google.com/js/api.js?onload=loadPicker';
/** @type {?} */
const SCOPE = ['https://www.googleapis.com/auth/drive'];
export class GoogleDriveService {
    /**
     * @param {?} http
     */
    constructor(http) {
        this.http = http;
        this.isDevMode = isDevMode();
        this.file$ = new Subject();
        this.selectedFile = this.file$.asObservable();
        this.pickerApiLoaded = false;
        this.googleApiUrl = GOOGLE_API_URL;
        this.googleApiLoaded = false;
        this.log = (/**
         * @param {?=} s
         * @param {...?} optional
         * @return {?}
         */
        (s, ...optional) => s && this.isDevMode && console.log(s, optional));
        this.log(`'google-drive.service'`);
        this.onAuthApiLoad = this.onAuthApiLoad.bind(this);
        this.onPickerApiLoad = this.onPickerApiLoad.bind(this);
        this.handleAuthResult = this.handleAuthResult.bind(this);
        this.pickerCallback = this.pickerCallback.bind(this);
    }
    /**
     * @return {?}
     */
    setDevMode() { this.isDevMode = true; }
    /**
     * @return {?}
     */
    ngOnDestroy() {
    }
    /**
     * @param {?} config
     * @return {?}
     */
    init(config) {
        this.config = config;
    }
    /**
     * @return {?}
     */
    loadScript() {
        if (!this.config)
            return;
        return new Promise((/**
         * @param {?} resolve
         * @param {?} reject
         * @return {?}
         */
        (resolve, reject) => {
            if (this.googleApiLoaded) {
                resolve('already loaded');
                return;
            }
            /** @type {?} */
            const script = document.createElement('script');
            script.type = 'text/javascript';
            script.src = this.googleApiUrl;
            script.onload = (/**
             * @return {?}
             */
            () => {
                this.googleApiLoaded = true;
                resolve('loaded');
            });
            script.onerror = ((/**
             * @param {?} error
             * @return {?}
             */
            error => resolve('failed to load')));
            document.getElementsByTagName('head')[0].appendChild(script);
        }));
    }
    /**
     * @return {?}
     */
    loadPicker() {
        if (!this.config)
            return;
        this.pickerApiLoaded = false;
        this.oauthToken = null;
        this.doLoadPicker();
    }
    /**
     * @private
     * @return {?}
     */
    doLoadPicker() {
        gapi.load('auth', { 'callback': this.onAuthApiLoad });
        gapi.load('picker', { 'callback': this.onPickerApiLoad });
    }
    /**
     * @private
     * @return {?}
     */
    onAuthApiLoad() {
        gapi.auth.authorize({
            'client_id': this.config.clientId,
            'scope': SCOPE,
            'immediate': false
        }, this.handleAuthResult);
    }
    /**
     * @private
     * @return {?}
     */
    onPickerApiLoad() {
        this.pickerApiLoaded = true;
        this.createPicker();
    }
    /**
     * @private
     * @param {?} authResult
     * @return {?}
     */
    handleAuthResult(authResult) {
        if (authResult && !authResult.error) {
            this.oauthToken = authResult.access_token;
            this.createPicker();
            this.log('handleAuthResult', authResult);
        }
    }
    /**
     * @private
     * @return {?}
     */
    createPicker() {
        if (this.pickerApiLoaded && this.oauthToken) {
            /** @type {?} */
            var origin = window.location.protocol + '//' + window.location.host;
            this.log(`createPicker origin '${origin}'`);
            /** @type {?} */
            var view = new google.picker.View(google.picker.ViewId.DOCS);
            view.setMimeTypes('image/png,image/jpeg,image/jpg');
            /** @type {?} */
            var picker = new google.picker.PickerBuilder()
                .enableFeature(google.picker.Feature.NAV_HIDDEN)
                .enableFeature(google.picker.Feature.MULTISELECT_ENABLED)
                .setAppId(this.config.appId)
                .setOAuthToken(this.oauthToken)
                .setOrigin(origin)
                .addView(view)
                .addView(new google.picker.DocsUploadView())
                // .setDeveloperKey(developerKey)
                .setCallback(this.pickerCallback)
                .build();
            picker.setVisible(true);
        }
    }
    /**
     * @private
     * @param {?} data
     * @return {?}
     */
    pickerCallback(data) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            if (data.action == google.picker.Action.PICKED) {
                /** @type {?} */
                const doc = data.docs[0];
                /** @type {?} */
                const fileId = doc.id;
                /** @type {?} */
                const accessToken = gapi.auth.getToken().access_token;
                this.log('The user selected', fileId, accessToken, doc);
                /** @type {?} */
                let file;
                yield this.getFile(fileId, accessToken).pipe(take(1))
                    .forEach((/**
                 * @param {?} blob
                 * @return {?}
                 */
                (blob) => {
                    file = new File([blob], doc.name, { type: blob.type });
                    this.file$.next(file);
                }));
            }
        });
    }
    /**
     * @private
     * @param {?} fileId
     * @param {?} accessToken
     * @return {?}
     */
    getFile(fileId, accessToken) {
        /** @type {?} */
        const url = `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`;
        return this.http.get(url, {
            headers: new HttpHeaders({
                'Authorization': `Bearer ${accessToken}`
            }),
            responseType: 'blob'
        });
    }
}
GoogleDriveService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
GoogleDriveService.ctorParameters = () => [
    { type: HttpClient }
];
if (false) {
    /** @type {?} */
    GoogleDriveService.prototype.isDevMode;
    /** @type {?} */
    GoogleDriveService.prototype.config;
    /**
     * @type {?}
     * @private
     */
    GoogleDriveService.prototype.file$;
    /** @type {?} */
    GoogleDriveService.prototype.selectedFile;
    /** @type {?} */
    GoogleDriveService.prototype.pickerApiLoaded;
    /** @type {?} */
    GoogleDriveService.prototype.oauthToken;
    /** @type {?} */
    GoogleDriveService.prototype.googleApiUrl;
    /** @type {?} */
    GoogleDriveService.prototype.googleApiLoaded;
    /** @type {?} */
    GoogleDriveService.prototype.log;
    /**
     * @type {?}
     * @private
     */
    GoogleDriveService.prototype.http;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ29vZ2xlLWRyaXZlLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9uZy1pbnB1dC1maWxlLyIsInNvdXJjZXMiOlsibGliL2dvb2dsZS1kcml2ZS5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBYSxTQUFTLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDakUsT0FBTyxFQUFFLFVBQVUsRUFBRSxXQUFXLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUMvRCxPQUFPLEVBQWMsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQzNDLE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQzs7OztBQUV0QyxxQ0FJQzs7O0lBSEMsdUNBQXFCOztJQUNyQixnQ0FBYzs7SUFDZCxtQ0FBaUI7OztNQUdiLGNBQWMsR0FBRyxxREFBcUQ7O01BQ3RFLEtBQUssR0FBRyxDQUFDLHVDQUF1QyxDQUFDO0FBSXZELE1BQU0sT0FBTyxrQkFBa0I7Ozs7SUFpQjdCLFlBQW9CLElBQWdCO1FBQWhCLFNBQUksR0FBSixJQUFJLENBQVk7UUFoQnBDLGNBQVMsR0FBRyxTQUFTLEVBQUUsQ0FBQztRQUloQixVQUFLLEdBQUcsSUFBSSxPQUFPLEVBQVEsQ0FBQztRQUNwQyxpQkFBWSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsWUFBWSxFQUFFLENBQUM7UUFFekMsb0JBQWUsR0FBRyxLQUFLLENBQUM7UUFHeEIsaUJBQVksR0FBRyxjQUFjLENBQUM7UUFDOUIsb0JBQWUsR0FBRyxLQUFLLENBQUM7UUFHeEIsUUFBRzs7Ozs7UUFBRyxDQUFDLENBQU8sRUFBRSxHQUFHLFFBQWUsRUFBRSxFQUFFLENBQUMsQ0FBQyxJQUFJLElBQUksQ0FBQyxTQUFTLElBQUksT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUUsUUFBUSxDQUFDLEVBQUM7UUFHckYsSUFBSSxDQUFDLEdBQUcsQ0FBQyx3QkFBd0IsQ0FBQyxDQUFD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ZUFBZSxFQUFFLFVBQVUsV0FBVyxFQUFFO2FBQ3pDLENBQUM7WUFDRixZQUFZLEVBQUUsTUFBTTtTQUNyQixDQUFDLENBQUM7SUFDTCxDQUFDOzs7WUF2SUYsVUFBVTs7OztZQWRGLFVBQVU7Ozs7SUFnQmpCLHVDQUF3Qjs7SUFFeEIsb0NBQXdCOzs7OztJQUV4QixtQ0FBb0M7O0lBQ3BDLDBDQUF5Qzs7SUFFekMsNkNBQXdCOztJQUN4Qix3Q0FBVzs7SUFFWCwwQ0FBOEI7O0lBQzlCLDZDQUF3Qjs7SUFHeEIsaUNBQXVGOzs7OztJQUUzRSxrQ0FBd0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBPbkRlc3Ryb3ksIGlzRGV2TW9kZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBIdHRwQ2xpZW50LCBIdHRwSGVhZGVycyB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbi9odHRwJztcclxuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyB0YWtlIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xyXG5cclxuZXhwb3J0IGludGVyZmFjZSBHb29nbGVBcGlDb25maWcge1xyXG4gIGRldmVsb3BlcktleTogc3RyaW5nO1xyXG4gIGFwcElkOiBzdHJpbmc7XHJcbiAgY2xpZW50SWQ6IHN0cmluZztcclxufVxyXG5cclxuY29uc3QgR09PR0xFX0FQSV9VUkwgPSAnaHR0cHM6Ly9hcGlzLmdvb2dsZS5jb20vanMvYXBpLmpzP29ubG9hZD1sb2FkUGlja2VyJztcclxuY29uc3QgU0NPUEUgPSBbJ2h0dHBzOi8vd3d3Lmdvb2dsZWFwaXMuY29tL2F1dGgvZHJpdmUnXTtcclxuZGVjbGFyZSB2YXIgZ29vZ2xlO1xyXG5cclxuQEluamVjdGFibGUoKVxyXG5leHBvcnQgY2xhc3MgR29vZ2xlRHJpdmVTZXJ2aWNlIGltcGxlbWVudHMgT25EZXN0cm95IHtcclxuICBpc0Rldk1vZGUgPSBpc0Rldk1vZGUoKTtcclxuXHJcbiAgY29uZmlnOiBHb29nbGVBcGlDb25maWc7XHJcblxyXG4gIHByaXZhdGUgZmlsZSQgPSBuZXcgU3ViamVjdDxGaWxlPigpO1xyXG4gIHNlbGVjdGVkRmlsZSA9IHRoaXMuZmlsZSQuYXNPYnNlcnZhYmxlKCk7XHJcblxyXG4gIHBpY2tlckFwaUxvYWRlZCA9IGZhbHNlO1xyXG4gIG9hdXRoVG9rZW47XHJcblxyXG4gIGdvb2dsZUFwaVVybCA9IEdPT0dMRV9BUElfVVJMO1xyXG4gIGdvb2dsZUFwaUxvYWRlZCA9IGZhbHNlO1xyXG5cclxuICBzZXREZXZNb2RlKCkgeyB0aGlzLmlzRGV2TW9kZSA9IHRydWU7IH1cclxuICBsb2cgPSAocz86IGFueSwgLi4ub3B0aW9uYWw6IGFueVtdKSA9PiBzICYmIHRoaXMuaXNEZXZNb2RlICYmIGNvbnNvbGUubG9nKHMsIG9wdGlvbmFsKTtcclxuXHJcbiAgY29uc3RydWN0b3IocHJpdmF0ZSBodHRwOiBIdHRwQ2xpZW50KSB7XHJcbiAgICB0aGlzLmxvZyhgJ2dvb2dsZS1kcml2ZS5zZXJ2aWNlJ2ApO1xyXG5cclxuICAgIHRoaXMub25BdXRoQXBpTG9hZCA9IHRoaXMub25BdXRoQXBpTG9hZC5iaW5kKHRoaXMpO1xyXG4gICAgdGhpcy5vblBpY2tlckFwaUxvYWQgPSB0aGlzLm9uUGlja2VyQXBpTG9hZC5iaW5kKHRoaXMpO1xyXG4gICAgdGhpcy5oYW5kbGVBdXRoUmVzdWx0ID0gdGhpcy5oYW5kbGVBdXRoUmVzdWx0LmJpbmQodGhpcyk7XHJcbiAgICB0aGlzLnBpY2tlckNhbGxiYWNrID0gdGhpcy5waWNrZXJDYWxsYmFjay5iaW5kKHRoaXMpO1xyXG4gIH1cclxuXHJcbiAgbmdPbkRlc3Ryb3koKSB7XHJcbiAgfVxyXG5cclxuICBpbml0KGNvbmZpZzogR29vZ2xlQXBpQ29uZmlnKSB7XHJcbiAgICB0aGlzLmNvbmZpZyA9IGNvbmZpZztcclxuICB9XHJcblxyXG4gIGxvYWRTY3JpcHQoKTogUHJvbWlzZTxhbnk+IHtcclxuICAgIGlmICghdGhpcy5jb25maWcpIHJldHVybjtcclxuXHJcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICBpZiAodGhpcy5nb29nbGVBcGlMb2FkZWQpIHtcclxuICAgICAgICByZXNvbHZlKCdhbHJlYWR5IGxvYWRlZCcpO1xyXG4gICAgICAgIHJldHVybjtcclxuICAgICAgfVxyXG4gICAgICBjb25zdCBzY3JpcHQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzY3JpcHQnKTtcclxuICAgICAgc2NyaXB0LnR5cGUgPSAndGV4dC9qYXZhc2NyaXB0JztcclxuICAgICAgc2NyaXB0LnNyYyA9IHRoaXMuZ29vZ2xlQXBpVXJsO1xyXG4gICAgICBzY3JpcHQub25sb2FkID0gKCkgPT4ge1xyXG4gICAgICAgIHRoaXMuZ29vZ2xlQXBpTG9hZGVkID0gdHJ1ZTtcclxuICAgICAgICByZXNvbHZlKCdsb2FkZWQnKTtcclxuICAgICAgfVxyXG4gICAgICBzY3JpcHQub25lcnJvciA9IChlcnJvciA9PiByZXNvbHZlKCdmYWlsZWQgdG8gbG9hZCcpKTtcclxuICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ2hlYWQnKVswXS5hcHBlbmRDaGlsZChzY3JpcHQpO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBsb2FkUGlja2VyKCkge1xyXG4gICAgaWYgKCF0aGlzLmNvbmZpZykgcmV0dXJuO1xyXG5cclxuICAgIHRoaXMucGlja2VyQXBpTG9hZGVkID0gZmFsc2U7XHJcbiAgICB0aGlzLm9hdXRoVG9rZW4gPSBudWxsO1xyXG4gICAgdGhpcy5kb0xvYWRQaWNrZXIoKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgZG9Mb2FkUGlja2VyKCkge1xyXG4gICAgZ2FwaS5sb2FkKCdhdXRoJywgeydjYWxsYmFjayc6IHRoaXMub25BdXRoQXBpTG9hZH0pO1xyXG4gICAgZ2FwaS5sb2FkKCdwaWNrZXInLCB7J2NhbGxiYWNrJzogdGhpcy5vblBpY2tlckFwaUxvYWR9KTtcclxuICB9XHJcbiAgcHJpdmF0ZSBvbkF1dGhBcGlMb2FkKCkge1xyXG4gICAgZ2FwaS5hdXRoLmF1dGhvcml6ZShcclxuICAgICAgICB7XHJcbiAgICAgICAgICAnY2xpZW50X2lkJzogdGhpcy5jb25maWcuY2xpZW50SWQsXHJcbiAgICAgICAgICAnc2NvcGUnOiBTQ09QRSxcclxuICAgICAgICAgICdpbW1lZGlhdGUnOiBmYWxzZVxyXG4gICAgICAgIH0sXHJcbiAgICAgICAgdGhpcy5oYW5kbGVBdXRoUmVzdWx0KTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgb25QaWNrZXJBcGlMb2FkKCkge1xyXG4gICAgdGhpcy5waWNrZXJBcGlMb2FkZWQgPSB0cnVlO1xyXG4gICAgdGhpcy5jcmVhdGVQaWNrZXIoKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgaGFuZGxlQXV0aFJlc3VsdChhdXRoUmVzdWx0KSB7XHJcbiAgICBpZiAoYXV0aFJlc3VsdCAmJiAhYXV0aFJlc3VsdC5lcnJvcikge1xyXG4gICAgICB0aGlzLm9hdXRoVG9rZW4gPSBhdXRoUmVzdWx0LmFjY2Vzc190b2tlbjtcclxuICAgICAgdGhpcy5jcmVhdGVQaWNrZXIoKTtcclxuICAgICAgdGhpcy5sb2coJ2hhbmRsZUF1dGhSZXN1bHQnLCBhdXRoUmVzdWx0KTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHByaXZhdGUgY3JlYXRlUGlja2VyKCkge1xyXG4gICAgaWYgKHRoaXMucGlja2VyQXBpTG9hZGVkICYmIHRoaXMub2F1dGhUb2tlbikge1xyXG4gICAgICB2YXIgb3JpZ2luID0gd2luZG93LmxvY2F0aW9uLnByb3RvY29sICsgJy8vJyArIHdpbmRvdy5sb2NhdGlvbi5ob3N0O1xyXG4gICAgICB0aGlzLmxvZyhgY3JlYXRlUGlja2VyIG9yaWdpbiAnJHtvcmlnaW59J2ApO1xyXG5cclxuICAgICAgdmFyIHZpZXcgPSBuZXcgZ29vZ2xlLnBpY2tlci5WaWV3KGdvb2dsZS5waWNrZXIuVmlld0lkLkRPQ1MpO1xyXG4gICAgICB2aWV3LnNldE1pbWVUeXBlcygnaW1hZ2UvcG5nLGltYWdlL2pwZWcsaW1hZ2UvanBnJyk7XHJcbiAgICAgIHZhciBwaWNrZXIgPSBuZXcgZ29vZ2xlLnBpY2tlci5QaWNrZXJCdWlsZGVyKClcclxuICAgICAgICAgIC5lbmFibGVGZWF0dXJlKGdvb2dsZS5waWNrZXIuRmVhdHVyZS5OQVZfSElEREVOKVxyXG4gICAgICAgICAgLmVuYWJsZUZlYXR1cmUoZ29vZ2xlLnBpY2tlci5GZWF0dXJlLk1VTFRJU0VMRUNUX0VOQUJMRUQpXHJcbiAgICAgICAgICAuc2V0QXBwSWQodGhpcy5jb25maWcuYXBwSWQpXHJcbiAgICAgICAgICAuc2V0T0F1dGhUb2tlbih0aGlzLm9hdXRoVG9rZW4pXHJcbiAgICAgICAgICAuc2V0T3JpZ2luKG9yaWdpbilcclxuICAgICAgICAgIC5hZGRWaWV3KHZpZXcpXHJcbiAgICAgICAgICAuYWRkVmlldyhuZXcgZ29vZ2xlLnBpY2tlci5Eb2NzVXBsb2FkVmlldygpKVxyXG4gICAgICAgICAgLy8gLnNldERldmVsb3BlcktleShkZXZlbG9wZXJLZXkpXHJcbiAgICAgICAgICAuc2V0Q2FsbGJhY2sodGhpcy5waWNrZXJDYWxsYmFjaylcclxuICAgICAgICAgIC5idWlsZCgpO1xyXG4gICAgICAgcGlja2VyLnNldFZpc2libGUodHJ1ZSk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGFzeW5jIHBpY2tlckNhbGxiYWNrKGRhdGEpIHtcclxuICAgIGlmIChkYXRhLmFjdGlvbiA9PSBnb29nbGUucGlja2VyLkFjdGlvbi5QSUNLRUQpIHtcclxuICAgICAgY29uc3QgZG9jID0gZGF0YS5kb2NzWzBdO1xyXG4gICAgICBjb25zdCBmaWxlSWQgPSBkb2MuaWQ7XHJcbiAgICAgIGNvbnN0IGFjY2Vzc1Rva2VuID0gZ2FwaS5hdXRoLmdldFRva2VuKCkuYWNjZXNzX3Rva2VuO1xyXG4gICAgICB0aGlzLmxvZygnVGhlIHVzZXIgc2VsZWN0ZWQnLCBmaWxlSWQsIGFjY2Vzc1Rva2VuLCBkb2MpO1xyXG5cclxuICAgICAgbGV0IGZpbGU6IEZpbGU7XHJcbiAgICAgIGF3YWl0IHRoaXMuZ2V0RmlsZShmaWxlSWQsIGFjY2Vzc1Rva2VuKS5waXBlKHRha2UoMSkpXHJcbiAgICAgICAgLmZvckVhY2goKGJsb2IpID0+IHtcclxuICAgICAgICAgIGZpbGUgPSBuZXcgRmlsZShbYmxvYl0sIGRvYy5uYW1lLCB7IHR5cGU6IGJsb2IudHlwZSB9KTtcclxuICAgICAgICAgIHRoaXMuZmlsZSQubmV4dChmaWxlKTtcclxuICAgICAgfSk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGdldEZpbGUoZmlsZUlkLCBhY2Nlc3NUb2tlbik6IE9ic2VydmFibGU8QmxvYj4ge1xyXG4gICAgY29uc3QgdXJsID0gYGh0dHBzOi8vd3d3Lmdvb2dsZWFwaXMuY29tL2RyaXZlL3YzL2ZpbGVzLyR7ZmlsZUlkfT9hbHQ9bWVkaWFgO1xyXG4gICAgcmV0dXJuIHRoaXMuaHR0cC5nZXQodXJsLCB7XHJcbiAgICAgIGhlYWRlcnM6IG5ldyBIdHRwSGVhZGVycyh7XHJcbiAgICAgICAgJ0F1dGhvcml6YXRpb24nOiBgQmVhcmVyICR7YWNjZXNzVG9rZW59YFxyXG4gICAgICB9KSxcclxuICAgICAgcmVzcG9uc2VUeXBlOiAnYmxvYidcclxuICAgIH0pO1xyXG4gIH1cclxufVxyXG4iXX0=