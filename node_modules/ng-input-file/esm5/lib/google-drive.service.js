/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { Injectable, isDevMode } from '@angular/core';
import { HttpClient, HttpHeaders } from '@angular/common/http';
import { Subject } from 'rxjs';
import { take } from 'rxjs/operators';
/**
 * @record
 */
export function GoogleApiConfig() { }
if (false) {
    /** @type {?} */
    GoogleApiConfig.prototype.developerKey;
    /** @type {?} */
    GoogleApiConfig.prototype.appId;
    /** @type {?} */
    GoogleApiConfig.prototype.clientId;
}
/** @type {?} */
var GOOGLE_API_URL = 'https://apis.google.com/js/api.js?onload=loadPicker';
/** @type {?} */
var SCOPE = ['https://www.googleapis.com/auth/drive'];
var GoogleDriveService = /** @class */ (function () {
    function GoogleDriveService(http) {
        var _this = this;
        this.http = http;
        this.isDevMode = isDevMode();
        this.file$ = new Subject();
        this.selectedFile = this.file$.asObservable();
        this.pickerApiLoaded = false;
        this.googleApiUrl = GOOGLE_API_URL;
        this.googleApiLoaded = false;
        this.log = (/**
         * @param {?=} s
         * @param {...?} optional
         * @return {?}
         */
        function (s) {
            var optional = [];
            for (var _i = 1; _i < arguments.length; _i++) {
                optional[_i - 1] = arguments[_i];
            }
            return s && _this.isDevMode && console.log(s, optional);
        });
        this.log("'google-drive.service'");
        this.onAuthApiLoad = this.onAuthApiLoad.bind(this);
        this.onPickerApiLoad = this.onPickerApiLoad.bind(this);
        this.handleAuthResult = this.handleAuthResult.bind(this);
        this.pickerCallback = this.pickerCallback.bind(this);
    }
    /**
     * @return {?}
     */
    GoogleDriveService.prototype.setDevMode = /**
     * @return {?}
     */
    function () { this.isDevMode = true; };
    /**
     * @return {?}
     */
    GoogleDriveService.prototype.ngOnDestroy = /**
     * @return {?}
     */
    function () {
    };
    /**
     * @param {?} config
     * @return {?}
     */
    GoogleDriveService.prototype.init = /**
     * @param {?} config
     * @return {?}
     */
    function (config) {
        this.config = config;
    };
    /**
     * @return {?}
     */
    GoogleDriveService.prototype.loadScript = /**
     * @return {?}
     */
    function () {
        var _this = this;
        if (!this.config)
            return;
        return new Promise((/**
         * @param {?} resolve
         * @param {?} reject
         * @return {?}
         */
        function (resolve, reject) {
            if (_this.googleApiLoaded) {
                resolve('already loaded');
                return;
            }
            /** @type {?} */
            var script = document.createElement('script');
            script.type = 'text/javascript';
            script.src = _this.googleApiUrl;
            script.onload = (/**
             * @return {?}
             */
            function () {
                _this.googleApiLoaded = true;
                resolve('loaded');
            });
            script.onerror = ((/**
             * @param {?} error
             * @return {?}
             */
            function (error) { return resolve('failed to load'); }));
            document.getElementsByTagName('head')[0].appendChild(script);
        }));
    };
    /**
     * @return {?}
     */
    GoogleDriveService.prototype.loadPicker = /**
     * @return {?}
     */
    function () {
        if (!this.config)
            return;
        this.pickerApiLoaded = false;
        this.oauthToken = null;
        this.doLoadPicker();
    };
    /**
     * @private
     * @return {?}
     */
    GoogleDriveService.prototype.doLoadPicker = /**
     * @private
     * @return {?}
     */
    function () {
        gapi.load('auth', { 'callback': this.onAuthApiLoad });
        gapi.load('picker', { 'callback': this.onPickerApiLoad });
    };
    /**
     * @private
     * @return {?}
     */
    GoogleDriveService.prototype.onAuthApiLoad = /**
     * @private
     * @return {?}
     */
    function () {
        gapi.auth.authorize({
            'client_id': this.config.clientId,
            'scope': SCOPE,
            'immediate': false
        }, this.handleAuthResult);
    };
    /**
     * @private
     * @return {?}
     */
    GoogleDriveService.prototype.onPickerApiLoad = /**
     * @private
     * @return {?}
     */
    function () {
        this.pickerApiLoaded = true;
        this.createPicker();
    };
    /**
     * @private
     * @param {?} authResult
     * @return {?}
     */
    GoogleDriveService.prototype.handleAuthResult = /**
     * @private
     * @param {?} authResult
     * @return {?}
     */
    function (authResult) {
        if (authResult && !authResult.error) {
            this.oauthToken = authResult.access_token;
            this.createPicker();
            this.log('handleAuthResult', authResult);
        }
    };
    /**
     * @private
     * @return {?}
     */
    GoogleDriveService.prototype.createPicker = /**
     * @private
     * @return {?}
     */
    function () {
        if (this.pickerApiLoaded && this.oauthToken) {
            /** @type {?} */
            var origin = window.location.protocol + '//' + window.location.host;
            this.log("createPicker origin '" + origin + "'");
            /** @type {?} */
            var view = new google.picker.View(google.picker.ViewId.DOCS);
            view.setMimeTypes('image/png,image/jpeg,image/jpg');
            /** @type {?} */
            var picker = new google.picker.PickerBuilder()
                .enableFeature(google.picker.Feature.NAV_HIDDEN)
                .enableFeature(google.picker.Feature.MULTISELECT_ENABLED)
                .setAppId(this.config.appId)
                .setOAuthToken(this.oauthToken)
                .setOrigin(origin)
                .addView(view)
                .addView(new google.picker.DocsUploadView())
                // .setDeveloperKey(developerKey)
                .setCallback(this.pickerCallback)
                .build();
            picker.setVisible(true);
        }
    };
    /**
     * @private
     * @param {?} data
     * @return {?}
     */
    GoogleDriveService.prototype.pickerCallback = /**
     * @private
     * @param {?} data
     * @return {?}
     */
    function (data) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var doc_1, fileId, accessToken, file_1;
            var _this = this;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        if (!(data.action == google.picker.Action.PICKED)) return [3 /*break*/, 2];
                        doc_1 = data.docs[0];
                        fileId = doc_1.id;
                        accessToken = gapi.auth.getToken().access_token;
                        this.log('The user selected', fileId, accessToken, doc_1);
                        return [4 /*yield*/, this.getFile(fileId, accessToken).pipe(take(1))
                                .forEach((/**
                             * @param {?} blob
                             * @return {?}
                             */
                            function (blob) {
                                file_1 = new File([blob], doc_1.name, { type: blob.type });
                                _this.file$.next(file_1);
                            }))];
                    case 1:
                        _a.sent();
                        _a.label = 2;
                    case 2: return [2 /*return*/];
                }
            });
        });
    };
    /**
     * @private
     * @param {?} fileId
     * @param {?} accessToken
     * @return {?}
     */
    GoogleDriveService.prototype.getFile = /**
     * @private
     * @param {?} fileId
     * @param {?} accessToken
     * @return {?}
     */
    function (fileId, accessToken) {
        /** @type {?} */
        var url = "https://www.googleapis.com/drive/v3/files/" + fileId + "?alt=media";
        return this.http.get(url, {
            headers: new HttpHeaders({
                'Authorization': "Bearer " + accessToken
            }),
            responseType: 'blob'
        });
    };
    GoogleDriveService.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    GoogleDriveService.ctorParameters = function () { return [
        { type: HttpClient }
    ]; };
    return GoogleDriveService;
}());
export { GoogleDriveService };
if (false) {
    /** @type {?} */
    GoogleDriveService.prototype.isDevMode;
    /** @type {?} */
    GoogleDriveService.prototype.config;
    /**
     * @type {?}
     * @private
     */
    GoogleDriveService.prototype.file$;
    /** @type {?} */
    GoogleDriveService.prototype.selectedFile;
    /** @type {?} */
    GoogleDriveService.prototype.pickerApiLoaded;
    /** @type {?} */
    GoogleDriveService.prototype.oauthToken;
    /** @type {?} */
    GoogleDriveService.prototype.googleApiUrl;
    /** @type {?} */
    GoogleDriveService.prototype.googleApiLoaded;
    /** @type {?} */
    GoogleDriveService.prototype.log;
    /**
     * @type {?}
     * @private
     */
    GoogleDriveService.prototype.http;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ29vZ2xlLWRyaXZlLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9uZy1pbnB1dC1maWxlLyIsInNvdXJjZXMiOlsibGliL2dvb2dsZS1kcml2ZS5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBYSxTQUFTLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDakUsT0FBTyxFQUFFLFVBQVUsRUFBRSxXQUFXLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUMvRCxPQUFPLEVBQWMsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQzNDLE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQzs7OztBQUV0QyxxQ0FJQzs7O0lBSEMsdUNBQXFCOztJQUNyQixnQ0FBYzs7SUFDZCxtQ0FBaUI7OztJQUdiLGNBQWMsR0FBRyxxREFBcUQ7O0lBQ3RFLEtBQUssR0FBRyxDQUFDLHVDQUF1QyxDQUFDO0FBR3ZEO0lBa0JFLDRCQUFvQixJQUFnQjtRQUFwQyxpQkFPQztRQVBtQixTQUFJLEdBQUosSUFBSSxDQUFZO1FBaEJwQyxjQUFTLEdBQUcsU0FBUyxFQUFFLENBQUM7UUFJaEIsVUFBSyxHQUFHLElBQUksT0FBTyxFQUFRLENBQUM7UUFDcEMsaUJBQVksR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLFlBQVksRUFBRSxDQUFDO1FBRXpDLG9CQUFlLEdBQUcsS0FBSyxDQUFDO1FBR3hCLGlCQUFZLEdBQUcsY0FBYyxDQUFDO1FBQzlCLG9CQUFlLEdBQUcsS0FBSyxDQUFDO1FBR3hCLFFBQUc7Ozs7O1FBQUcsVUFBQyxDQUFPO1lBQUUsa0JBQWtCO2lCQUFsQixVQUFrQixFQUFsQixxQkFBa0IsRUFBbEIsSUFBa0I7Z0JBQWxCLGlDQUFrQjs7WUFBSyxPQUFBLENBQUMsSUFBSSxLQUFJLENBQUMsU0FBUyxJQUFJLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLFFBQVEsQ0FBQztRQUEvQyxDQUEr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LG9DQUFPOzs7Ozs7SUFBZixVQUFnQixNQUFNLEVBQUUsV0FBVzs7WUFDM0IsR0FBRyxHQUFHLCtDQUE2QyxNQUFNLGVBQVk7UUFDM0UsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLEVBQUU7WUFDeEIsT0FBTyxFQUFFLElBQUksV0FBVyxDQUFDO2dCQUN2QixlQUFlLEVBQUUsWUFBVSxXQUFhO2FBQ3pDLENBQUM7WUFDRixZQUFZLEVBQUUsTUFBTTtTQUNyQixDQUFDLENBQUM7SUFDTCxDQUFDOztnQkF2SUYsVUFBVTs7OztnQkFkRixVQUFVOztJQXNKbkIseUJBQUM7Q0FBQSxBQXhJRCxJQXdJQztTQXZJWSxrQkFBa0I7OztJQUM3Qix1Q0FBd0I7O0lBRXhCLG9DQUF3Qjs7Ozs7SUFFeEIsbUNBQW9DOztJQUNwQywwQ0FBeUM7O0lBRXpDLDZDQUF3Qjs7SUFDeEIsd0NBQVc7O0lBRVgsMENBQThCOztJQUM5Qiw2Q0FBd0I7O0lBR3hCLGlDQUF1Rjs7Ozs7SUFFM0Usa0NBQXdCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSwgT25EZXN0cm95LCBpc0Rldk1vZGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgSHR0cENsaWVudCwgSHR0cEhlYWRlcnMgfSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XHJcbmltcG9ydCB7IE9ic2VydmFibGUsIFN1YmplY3QgfSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHsgdGFrZSB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgR29vZ2xlQXBpQ29uZmlnIHtcclxuICBkZXZlbG9wZXJLZXk6IHN0cmluZztcclxuICBhcHBJZDogc3RyaW5nO1xyXG4gIGNsaWVudElkOiBzdHJpbmc7XHJcbn1cclxuXHJcbmNvbnN0IEdPT0dMRV9BUElfVVJMID0gJ2h0dHBzOi8vYXBpcy5nb29nbGUuY29tL2pzL2FwaS5qcz9vbmxvYWQ9bG9hZFBpY2tlcic7XHJcbmNvbnN0IFNDT1BFID0gWydodHRwczovL3d3dy5nb29nbGVhcGlzLmNvbS9hdXRoL2RyaXZlJ107XHJcbmRlY2xhcmUgdmFyIGdvb2dsZTtcclxuXHJcbkBJbmplY3RhYmxlKClcclxuZXhwb3J0IGNsYXNzIEdvb2dsZURyaXZlU2VydmljZSBpbXBsZW1lbnRzIE9uRGVzdHJveSB7XHJcbiAgaXNEZXZNb2RlID0gaXNEZXZNb2RlKCk7XHJcblxyXG4gIGNvbmZpZzogR29vZ2xlQXBpQ29uZmlnO1xyXG5cclxuICBwcml2YXRlIGZpbGUkID0gbmV3IFN1YmplY3Q8RmlsZT4oKTtcclxuICBzZWxlY3RlZEZpbGUgPSB0aGlzLmZpbGUkLmFzT2JzZXJ2YWJsZSgpO1xyXG5cclxuICBwaWNrZXJBcGlMb2FkZWQgPSBmYWxzZTtcclxuICBvYXV0aFRva2VuO1xyXG5cclxuICBnb29nbGVBcGlVcmwgPSBHT09HTEVfQVBJX1VSTDtcclxuICBnb29nbGVBcGlMb2FkZWQgPSBmYWxzZTtcclxuXHJcbiAgc2V0RGV2TW9kZSgpIHsgdGhpcy5pc0Rldk1vZGUgPSB0cnVlOyB9XHJcbiAgbG9nID0gKHM/OiBhbnksIC4uLm9wdGlvbmFsOiBhbnlbXSkgPT4gcyAmJiB0aGlzLmlzRGV2TW9kZSAmJiBjb25zb2xlLmxvZyhzLCBvcHRpb25hbCk7XHJcblxyXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgaHR0cDogSHR0cENsaWVudCkge1xyXG4gICAgdGhpcy5sb2coYCdnb29nbGUtZHJpdmUuc2VydmljZSdgKTtcclxuXHJcbiAgICB0aGlzLm9uQXV0aEFwaUxvYWQgPSB0aGlzLm9uQXV0aEFwaUxvYWQuYmluZCh0aGlzKTtcclxuICAgIHRoaXMub25QaWNrZXJBcGlMb2FkID0gdGhpcy5vblBpY2tlckFwaUxvYWQuYmluZCh0aGlzKTtcclxuICAgIHRoaXMuaGFuZGxlQXV0aFJlc3VsdCA9IHRoaXMuaGFuZGxlQXV0aFJlc3VsdC5iaW5kKHRoaXMpO1xyXG4gICAgdGhpcy5waWNrZXJDYWxsYmFjayA9IHRoaXMucGlja2VyQ2FsbGJhY2suYmluZCh0aGlzKTtcclxuICB9XHJcblxyXG4gIG5nT25EZXN0cm95KCkge1xyXG4gIH1cclxuXHJcbiAgaW5pdChjb25maWc6IEdvb2dsZUFwaUNvbmZpZykge1xyXG4gICAgdGhpcy5jb25maWcgPSBjb25maWc7XHJcbiAgfVxyXG5cclxuICBsb2FkU2NyaXB0KCk6IFByb21pc2U8YW55PiB7XHJcbiAgICBpZiAoIXRoaXMuY29uZmlnKSByZXR1cm47XHJcblxyXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgICAgaWYgKHRoaXMuZ29vZ2xlQXBpTG9hZGVkKSB7XHJcbiAgICAgICAgcmVzb2x2ZSgnYWxyZWFkeSBsb2FkZWQnKTtcclxuICAgICAgICByZXR1cm47XHJcbiAgICAgIH1cclxuICAgICAgY29uc3Qgc2NyaXB0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc2NyaXB0Jyk7XHJcbiAgICAgIHNjcmlwdC50eXBlID0gJ3RleHQvamF2YXNjcmlwdCc7XHJcbiAgICAgIHNjcmlwdC5zcmMgPSB0aGlzLmdvb2dsZUFwaVVybDtcclxuICAgICAgc2NyaXB0Lm9ubG9hZCA9ICgpID0+IHtcclxuICAgICAgICB0aGlzLmdvb2dsZUFwaUxvYWRlZCA9IHRydWU7XHJcbiAgICAgICAgcmVzb2x2ZSgnbG9hZGVkJyk7XHJcbiAgICAgIH1cclxuICAgICAgc2NyaXB0Lm9uZXJyb3IgPSAoZXJyb3IgPT4gcmVzb2x2ZSgnZmFpbGVkIHRvIGxvYWQnKSk7XHJcbiAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCdoZWFkJylbMF0uYXBwZW5kQ2hpbGQoc2NyaXB0KTtcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgbG9hZFBpY2tlcigpIHtcclxuICAgIGlmICghdGhpcy5jb25maWcpIHJldHVybjtcclxuXHJcbiAgICB0aGlzLnBpY2tlckFwaUxvYWRlZCA9IGZhbHNlO1xyXG4gICAgdGhpcy5vYXV0aFRva2VuID0gbnVsbDtcclxuICAgIHRoaXMuZG9Mb2FkUGlja2VyKCk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGRvTG9hZFBpY2tlcigpIHtcclxuICAgIGdhcGkubG9hZCgnYXV0aCcsIHsnY2FsbGJhY2snOiB0aGlzLm9uQXV0aEFwaUxvYWR9KTtcclxuICAgIGdhcGkubG9hZCgncGlja2VyJywgeydjYWxsYmFjayc6IHRoaXMub25QaWNrZXJBcGlMb2FkfSk7XHJcbiAgfVxyXG4gIHByaXZhdGUgb25BdXRoQXBpTG9hZCgpIHtcclxuICAgIGdhcGkuYXV0aC5hdXRob3JpemUoXHJcbiAgICAgICAge1xyXG4gICAgICAgICAgJ2NsaWVudF9pZCc6IHRoaXMuY29uZmlnLmNsaWVudElkLFxyXG4gICAgICAgICAgJ3Njb3BlJzogU0NPUEUsXHJcbiAgICAgICAgICAnaW1tZWRpYXRlJzogZmFsc2VcclxuICAgICAgICB9LFxyXG4gICAgICAgIHRoaXMuaGFuZGxlQXV0aFJlc3VsdCk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIG9uUGlja2VyQXBpTG9hZCgpIHtcclxuICAgIHRoaXMucGlja2VyQXBpTG9hZGVkID0gdHJ1ZTtcclxuICAgIHRoaXMuY3JlYXRlUGlja2VyKCk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGhhbmRsZUF1dGhSZXN1bHQoYXV0aFJlc3VsdCkge1xyXG4gICAgaWYgKGF1dGhSZXN1bHQgJiYgIWF1dGhSZXN1bHQuZXJyb3IpIHtcclxuICAgICAgdGhpcy5vYXV0aFRva2VuID0gYXV0aFJlc3VsdC5hY2Nlc3NfdG9rZW47XHJcbiAgICAgIHRoaXMuY3JlYXRlUGlja2VyKCk7XHJcbiAgICAgIHRoaXMubG9nKCdoYW5kbGVBdXRoUmVzdWx0JywgYXV0aFJlc3VsdCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGNyZWF0ZVBpY2tlcigpIHtcclxuICAgIGlmICh0aGlzLnBpY2tlckFwaUxvYWRlZCAmJiB0aGlzLm9hdXRoVG9rZW4pIHtcclxuICAgICAgdmFyIG9yaWdpbiA9IHdpbmRvdy5sb2NhdGlvbi5wcm90b2NvbCArICcvLycgKyB3aW5kb3cubG9jYXRpb24uaG9zdDtcclxuICAgICAgdGhpcy5sb2coYGNyZWF0ZVBpY2tlciBvcmlnaW4gJyR7b3JpZ2lufSdgKTtcclxuXHJcbiAgICAgIHZhciB2aWV3ID0gbmV3IGdvb2dsZS5waWNrZXIuVmlldyhnb29nbGUucGlja2VyLlZpZXdJZC5ET0NTKTtcclxuICAgICAgdmlldy5zZXRNaW1lVHlwZXMoJ2ltYWdlL3BuZyxpbWFnZS9qcGVnLGltYWdlL2pwZycpO1xyXG4gICAgICB2YXIgcGlja2VyID0gbmV3IGdvb2dsZS5waWNrZXIuUGlja2VyQnVpbGRlcigpXHJcbiAgICAgICAgICAuZW5hYmxlRmVhdHVyZShnb29nbGUucGlja2VyLkZlYXR1cmUuTkFWX0hJRERFTilcclxuICAgICAgICAgIC5lbmFibGVGZWF0dXJlKGdvb2dsZS5waWNrZXIuRmVhdHVyZS5NVUxUSVNFTEVDVF9FTkFCTEVEKVxyXG4gICAgICAgICAgLnNldEFwcElkKHRoaXMuY29uZmlnLmFwcElkKVxyXG4gICAgICAgICAgLnNldE9BdXRoVG9rZW4odGhpcy5vYXV0aFRva2VuKVxyXG4gICAgICAgICAgLnNldE9yaWdpbihvcmlnaW4pXHJcbiAgICAgICAgICAuYWRkVmlldyh2aWV3KVxyXG4gICAgICAgICAgLmFkZFZpZXcobmV3IGdvb2dsZS5waWNrZXIuRG9jc1VwbG9hZFZpZXcoKSlcclxuICAgICAgICAgIC8vIC5zZXREZXZlbG9wZXJLZXkoZGV2ZWxvcGVyS2V5KVxyXG4gICAgICAgICAgLnNldENhbGxiYWNrKHRoaXMucGlja2VyQ2FsbGJhY2spXHJcbiAgICAgICAgICAuYnVpbGQoKTtcclxuICAgICAgIHBpY2tlci5zZXRWaXNpYmxlKHRydWUpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBhc3luYyBwaWNrZXJDYWxsYmFjayhkYXRhKSB7XHJcbiAgICBpZiAoZGF0YS5hY3Rpb24gPT0gZ29vZ2xlLnBpY2tlci5BY3Rpb24uUElDS0VEKSB7XHJcbiAgICAgIGNvbnN0IGRvYyA9IGRhdGEuZG9jc1swXTtcclxuICAgICAgY29uc3QgZmlsZUlkID0gZG9jLmlkO1xyXG4gICAgICBjb25zdCBhY2Nlc3NUb2tlbiA9IGdhcGkuYXV0aC5nZXRUb2tlbigpLmFjY2Vzc190b2tlbjtcclxuICAgICAgdGhpcy5sb2coJ1RoZSB1c2VyIHNlbGVjdGVkJywgZmlsZUlkLCBhY2Nlc3NUb2tlbiwgZG9jKTtcclxuXHJcbiAgICAgIGxldCBmaWxlOiBGaWxlO1xyXG4gICAgICBhd2FpdCB0aGlzLmdldEZpbGUoZmlsZUlkLCBhY2Nlc3NUb2tlbikucGlwZSh0YWtlKDEpKVxyXG4gICAgICAgIC5mb3JFYWNoKChibG9iKSA9PiB7XHJcbiAgICAgICAgICBmaWxlID0gbmV3IEZpbGUoW2Jsb2JdLCBkb2MubmFtZSwgeyB0eXBlOiBibG9iLnR5cGUgfSk7XHJcbiAgICAgICAgICB0aGlzLmZpbGUkLm5leHQoZmlsZSk7XHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBnZXRGaWxlKGZpbGVJZCwgYWNjZXNzVG9rZW4pOiBPYnNlcnZhYmxlPEJsb2I+IHtcclxuICAgIGNvbnN0IHVybCA9IGBodHRwczovL3d3dy5nb29nbGVhcGlzLmNvbS9kcml2ZS92My9maWxlcy8ke2ZpbGVJZH0/YWx0PW1lZGlhYDtcclxuICAgIHJldHVybiB0aGlzLmh0dHAuZ2V0KHVybCwge1xyXG4gICAgICBoZWFkZXJzOiBuZXcgSHR0cEhlYWRlcnMoe1xyXG4gICAgICAgICdBdXRob3JpemF0aW9uJzogYEJlYXJlciAke2FjY2Vzc1Rva2VufWBcclxuICAgICAgfSksXHJcbiAgICAgIHJlc3BvbnNlVHlwZTogJ2Jsb2InXHJcbiAgICB9KTtcclxuICB9XHJcbn1cclxuIl19